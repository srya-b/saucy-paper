\begin{bbox}[title={$\mathcal{F}_\msf{Atomic-Final}$}]

Initialize: $\msf{BC} \leftarrow \emptyset$

\OnInput \inmsg{tx} from $P_i$:
	\begin{enumerate}
		%\item \Leak (\msf{tx}, \Partyi)
		\item \Send (\Leak, (\msf{tx}, \Partyi)) $\rightarrow \Wasync$

		\item \Send (\Schedule, \msf{Broadcast}, \msf{tx}) $\rightarrow \Wasync$

		\item Receive Ok $\leftarrow \Wasync$, \Send Ok $\rightarrow P_i$

	\end{enumerate}
   
{\color{Blue} {\bf Code} \tsc{Broadcast} $(msg)$:}

	\begin{enumerate}
		\item {\color{Blue} Append $msg$ to \msf{BC}, $\msf{pos} \leftarrow |\msf{BC}|$}

		\item {\color{Blue} For each $P_j$:}

			\quad {\color{Blue} \Leak (\msf{pos}, $P_j$)}

			\quad {\color{Blue} \Send (\Schedule, \tsc{Send}, (\msf{BC}[1:\msf{pos}], $P_j$)) $\rightarrow \Wasync$}
		
    \end{enumerate}

{\color{Red} {\bf Code} \tsc{Send} $(msg, P_i)$: \Send $msg \rightarrow P_i$ }


\end{bbox}
